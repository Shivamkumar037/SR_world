<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Admin Portal - Fixed Layout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
        }
        
        /* Custom Scrollbar for better UX */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Fixed Sidebar Active State */
        .nav-item.active { background-color: #1e293b; color: #3b82f6; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl relative overflow-hidden fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 text-white rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                    <i data-lucide="shield-check" width="32" height="32"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800" id="auth-title">Admin Login</h2>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" id="loginEmail" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="admin@system.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="loginPass" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="••••••••">
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex justify-center items-center">
                    <span id="loginBtnText">Login Dashboard</span>
                </button>
            </form>

            <!-- Register Form (Hidden by default) -->
            <form id="registerForm" class="space-y-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label>
                        <input type="text" name="name" required class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mobile</label>
                        <input type="tel" name="mobile" required class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" name="email" required class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" name="password" required class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none">
                </div>
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="block text-xs font-bold text-yellow-700 uppercase mb-1">Secret Key (<span class="text-red-500">ADMIN_SECRET_CODE</span>)</label>
                    <input type="text" name="refCode" required placeholder="Enter Secret Code" class="w-full px-4 py-2 rounded-lg border border-yellow-300 outline-none focus:ring-2 focus:ring-yellow-400 bg-white">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex justify-center items-center shadow-lg shadow-blue-200">
                    <span id="regBtnText">Create Admin Account</span>
                </button>
            </form>

            <!-- Toggle Button -->
            <div class="mt-6 text-center pt-4 border-t border-slate-100">
                <p class="text-sm text-slate-600" id="toggleText">New Admin?</p>
                <button onclick="toggleAuthMode()" class="text-blue-600 font-bold text-sm hover:underline" id="toggleBtn">Register Here</button>
            </div>

            <p id="authError" class="text-red-500 text-sm text-center mt-4 hidden bg-red-50 p-2 rounded border border-red-100"></p>
        </div>
    </div>
    
    <!-- DASHBOARD CONTAINER -->
    <div class="flex-1 flex h-full">

        <!-- SIDEBAR -->
        <aside class="w-64 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col transition-all duration-300 h-full hidden md:flex" id="sidebar">
            <div class="h-16 flex items-center px-6 border-b border-slate-800">
                <h1 class="text-lg font-bold text-white tracking-wide">ADMIN<span class="text-blue-500">PANEL</span></h1>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg active"><i data-lucide="bar-chart-2" class="w-5 h-5 mr-3 text-blue-500"></i> Overview</button>
                <button onclick="switchTab('resources')" id="nav-resources" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-slate-800"><i data-lucide="files" class="w-5 h-5 mr-3"></i> Resources</button>
                <button onclick="switchTab('users')" id="nav-users" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg hover:bg-slate-800"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Users</button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-sm text-red-400 hover:bg-slate-800 rounded-lg"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Logout</button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            
            <!-- HEADER (Fixed Top) -->
            <header class="h-16 bg-white shadow-md flex items-center justify-between px-6 flex-shrink-0 z-20">
                <h2 class="text-lg font-bold text-slate-700" id="page-title">Dashboard Overview</h2>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-slate-800" id="adminName">Administrator</p>
                        <p class="text-xs text-slate-500" id="adminEmailDisplay"></p>
                    </div>
                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200">
                        A
                    </div>
                </div>
            </header>

            <!-- SCROLLABLE CONTENT AREA (Flex Grow) -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                
                <!-- 1. DASHBOARD SECTION -->
                <div id="section-dashboard" class="fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex items-center"><i data-lucide="users" class="w-8 h-8 text-indigo-500 mr-4"></i><div><p class="text-sm font-medium text-slate-500">Total Users</p><h3 class="text-3xl font-bold text-slate-800" id="stat-users">0</h3></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex items-center"><i data-lucide="file-text" class="w-8 h-8 text-emerald-500 mr-4"></i><div><p class="text-sm font-medium text-slate-500">Total Resources</p><h3 class="text-3xl font-bold text-slate-800" id="stat-files">0</h3></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex items-center"><i data-lucide="server" class="w-8 h-8 text-orange-500 mr-4"></i><div><p class="text-sm font-medium text-slate-500">API Status</p><h3 class="text-sm font-bold text-green-600 flex items-center mt-1"><span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span> Online</h3></div></div>
                    </div>

                    <div class="bg-blue-100 border border-blue-200 rounded-2xl p-6 shadow-md">
                        <h3 class="text-xl font-bold text-blue-800 mb-2">System Health Check</h3>
                        <p class="text-blue-700">All services are operating normally. The database connection is active.</p>
                    </div>
                </div>

                <!-- 2. RESOURCES SECTION -->
                <div id="section-resources" class="hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">All Uploaded Files</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="files-table">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">File Name</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">Uploader</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="files-table-body" class="divide-y divide-slate-100">
                                    <!-- Files injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. USERS SECTION -->
                <div id="section-users" class="hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Registered Users</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="users-table">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">User Name</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">Email</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y divide-slate-100">
                                    <!-- Users injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- JS -->
    <script>
        const API_BASE_URL = 'https://library-system-backend-rxkz.onrender.com/api';
        let adminUser = null;
        let isRegisterMode = false;
        
        const sections = {
            dashboard: document.getElementById('section-dashboard'),
            resources: document.getElementById('section-resources'),
            users: document.getElementById('section-users')
        };
        const navItems = {
            dashboard: document.getElementById('nav-dashboard'),
            resources: document.getElementById('nav-resources'),
            users: document.getElementById('nav-users')
        };
        const pageTitle = document.getElementById('page-title');

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const stored = localStorage.getItem('libraryAdmin');
            if (stored) {
                adminUser = JSON.parse(stored);
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('adminName').textContent = adminUser.name;
                document.getElementById('adminEmailDisplay').textContent = adminUser.email;
                fetchData();
            }
        });

        // --- AUTH ---
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-title');
            const loginForm = document.getElementById('loginForm');
            const regForm = document.getElementById('registerForm');
            const toggleText = document.getElementById('toggleText');
            const toggleBtn = document.getElementById('toggleBtn');
            const errorMsg = document.getElementById('authError');

            errorMsg.classList.add('hidden');

            title.textContent = isRegisterMode ? "New Admin Registration" : "Admin Login";
            loginForm.classList.toggle('hidden', isRegisterMode);
            regForm.classList.toggle('hidden', !isRegisterMode);
            toggleText.textContent = isRegisterMode ? "Already have an account?" : "New Admin?";
            toggleBtn.textContent = isRegisterMode ? "Login Here" : "Register Here";
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            handleAuth('/auth/login', {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPass').value
            }, 'loginBtnText');
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            if(data.refCode !== 'ADMIN_SECRET_CODE') {
                document.getElementById('authError').textContent = "Invalid Secret Key!";
                document.getElementById('authError').classList.remove('hidden');
                return;
            }
            handleAuth('/auth/register', data, 'regBtnText');
        });

        async function handleAuth(endpoint, body, btnId) {
            const btn = document.getElementById(btnId);
            const originalText = btn.textContent;
            btn.innerHTML = '<div class="loader mr-2"></div> Processing...';
            btn.disabled = true;

            const errorMsg = document.getElementById('authError');
            errorMsg.classList.add('hidden');
            
            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Request failed');
                
                if (endpoint.includes('login') && !data.isAdmin) {
                    throw new Error('Access Denied: You are not an Admin. Login failed.');
                }

                if (endpoint.includes('register')) {
                    alert("Admin Account Created! Please Login.");
                    toggleAuthMode();
                } else {
                    localStorage.setItem('libraryAdmin', JSON.stringify(data));
                    adminUser = data;
                    window.location.reload();
                }

            } catch (err) {
                errorMsg.textContent = err.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function handleLogout() {
            localStorage.removeItem('libraryAdmin');
            window.location.reload();
        }

        // --- DASHBOARD LOGIC ---
        async function fetchData() {
            try {
                const [usersRes, filesRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/admin/users?adminIdentifier=${adminUser.email}`),
                    fetch(`${API_BASE_URL}/books/recent`)
                ]);

                if(usersRes.ok) {
                    usersData = await usersRes.json();
                    document.getElementById('stat-users').textContent = usersData.length;
                    renderUsers(usersData);
                }
                if(filesRes.ok) {
                    filesData = await filesRes.json();
                    document.getElementById('stat-files').textContent = filesData.length;
                    renderFiles(filesData);
                }
            } catch(e) { console.error(e); }
        }

        function renderUsers(users) {
            const body = document.getElementById('users-table-body');
            body.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">${u.name}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${u.email}</td>
                    <td class="px-6 py-4">
                        <span class="text-xs font-medium ${u.isAdmin ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'} px-2 py-1 rounded-full">
                            ${u.isAdmin ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${!u.isAdmin ? `<button onclick="deleteUser(${u.id})" class="text-red-500 hover:text-white hover:bg-red-600 text-xs font-bold bg-red-50 px-3 py-1 rounded transition-colors">Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderFiles(files) {
            const body = document.getElementById('files-table-body');
            body.innerHTML = files.map(f => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">${f.bookName}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${f.uploadedByUserName || 'Unknown'}</td>
                    <td class="px-6 py-4 text-right">
                        <a href="${f.downloadUrl}" target="_blank" class="text-blue-500 hover:text-white hover:bg-blue-600 text-xs font-bold bg-blue-50 px-3 py-1 rounded transition-colors mr-2">Download</a>
                        <button onclick="deleteFile(${f.id})" class="text-red-500 hover:text-white hover:bg-red-600 text-xs font-bold bg-red-50 px-3 py-1 rounded transition-colors">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteUser(id) {
            if(!confirm("Are you sure you want to delete this user? This action is permanent.")) return;
            try {
                await fetch(`${API_BASE_URL}/admin/users/${id}?adminIdentifier=${adminUser.email}`, { method: 'DELETE' });
                alert("User deleted successfully.");
                fetchData();
            } catch (e) {
                alert("Error deleting user: " + e.message);
            }
        }
        async function deleteFile(id) {
            if(!confirm("Are you sure you want to delete this file? This action is permanent.")) return;
            try {
                await fetch(`${API_BASE_URL}/books/${id}?deleterIdentifier=${adminUser.email}`, { method: 'DELETE' });
                alert("File deleted successfully.");
                fetchData();
            } catch (e) {
                alert("Error deleting file: " + e.message);
            }
        }

        // --- NAVIGATION ---
        function switchTab(tabName) {
            // Section visibility
            Object.keys(sections).forEach(key => sections[key].classList.toggle('hidden', key !== tabName));
            
            // Navbar active state
            Object.keys(navItems).forEach(key => navItems[key].classList.remove('active'));
            navItems[tabName].classList.add('active');
            
            // Title update
            const titles = { dashboard: 'Dashboard Overview', resources: 'Resource Management', users: 'User Management' };
            pageTitle.textContent = titles[tabName];
        }
    </script>
</body>
</html>
