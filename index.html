<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Resource - Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #F0F9FF; /* Light Blue BG */
        }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Custom Loader */
        .loader-white {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Input field focus glow */
        .input-glow {
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-glow:focus {
            border-color: #2563EB;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden bg-[#F0F9FF]">

    <div id="app" class="flex-1 flex flex-col relative h-full overflow-hidden"></div>
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[70] flex flex-col gap-2 w-full max-w-xs px-4 pointer-events-none"></div>

    <!-- Edit Modal (Hidden by Default) -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl border border-slate-100">
            <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Edit Resource</h3>
            <form id="editForm" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="editBookId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Title</label>
                        <input type="text" id="editBookName" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none input-glow font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Description</label>
                        <textarea id="editDescription" required rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none input-glow font-medium resize-none"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-slate-100 text-slate-600 font-bold rounded-xl active:scale-95 transition">Cancel</button>
                    <button type="submit" id="saveEditBtn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-xl active:scale-95 transition flex items-center justify-center">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Delete Confirmation Modal (NEW) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl border border-slate-100 text-center">
            <input type="hidden" id="confirmBookId">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Confirm Deletion</h3>
            <p class="text-sm text-slate-500 mb-6">Are you sure you want to permanently delete this resource?</p>
            
            <div class="flex justify-between space-x-3">
                <button type="button" onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl active:scale-95 transition">Cancel</button>
                <button type="button" onclick="executeDelete()" id="confirmDeleteBtn" class="flex-1 px-4 py-3 bg-red-600 text-white font-bold rounded-xl active:scale-95 transition flex items-center justify-center">
                    Delete
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIG ---
        const API_BASE_URL = 'https://library-system-backend-rxkz.onrender.com/api';
        const INSTAGRAM_LINK = 'https://www.instagram.com/shivam_kumar037s';

        // --- STATE ---
        const state = {
            view: 'auth',
            authView: 'login',
            activeTab: 'home',
            user: null,
            recentBooks: [],
            userBooks: [],
            wishlist: JSON.parse(localStorage.getItem('sr_wishlist') || '[]'),
            selectedBook: null,
            selectedBookPreview: null, // Store JSON result from /books/view/{id}
            searchQuery: '',
            selectedCategory: 'All',
            loading: false
        };

        const categories = [
            { name: 'All', icon: 'layout-grid', color: 'bg-blue-100 text-blue-600 border-blue-200' },
            { name: 'Physics', icon: 'atom', color: 'bg-amber-100 text-amber-600 border-amber-200' },
            { name: 'Math', icon: 'calculator', color: 'bg-emerald-100 text-emerald-600 border-emerald-200' },
            { name: 'Java', icon: 'coffee', color: 'bg-red-100 text-red-600 border-red-200' },
            { name: 'Python', icon: 'code-2', color: 'bg-green-100 text-green-600 border-green-200' },
            { name: 'Notes', icon: 'sticky-note', color: 'bg-purple-100 text-purple-600 border-purple-200' },
        ];

        // --- DOM ---
        const app = document.getElementById('app');
        const toastContainer = document.getElementById('toast-container');
        const editModal = document.getElementById('editModal');
        const confirmModal = document.getElementById('confirmModal');


        // --- INIT ---
        function init() {
            const savedUser = localStorage.getItem('studentResourceUser');
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                state.view = 'main';
                fetchRecentBooks();
                if (state.user) fetchUserBooks(state.user.email);
            }
            render();
        }

        // --- API & DATA ---
        async function fetchRecentBooks() {
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/books/recent`);
                if (!res.ok) throw new Error('Failed to load resources');
                state.recentBooks = await res.json();
                render();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                setLoading(false);
                render();
            }
        }

        async function fetchUserBooks(email) {
            if (!email) return;
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/books/user/${email}`);
                if (!res.ok) throw new Error('Failed to load uploads');
                state.userBooks = await res.json();
                render();
            } catch (err) {
                console.error(err);
            } finally {
                setLoading(false);
            }
        }
        
        async function fetchPreview(bookId) {
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/books/view/${bookId}`);
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Preview failed');
                }
                const data = await res.json();
                state.selectedBookPreview = data;
            } catch (err) {
                showToast(`Preview Error: ${err.message}`, 'error');
                state.selectedBookPreview = { error: true, message: err.message };
            } finally {
                setLoading(false);
                render();
            }
        }

        // --- AUTH ---
        async function handleAuth(e, type) {
            e.preventDefault();
            const form = e.target;
            const email = form.email.value;
            
            if (!email.toLowerCase().endsWith('@gmail.com')) {
                showToast("Only @gmail.com is allowed", "error");
                return;
            }

            setLoading(true);
            render();

            try {
                const endpoint = type === 'login' ? '/auth/login' : '/auth/register';
                const body = { 
                    email: email, 
                    password: form.password.value,
                    name: type === 'register' ? form.name.value : undefined,
                    mobile: type === 'register' ? form.mobile.value : undefined,
                };

                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Auth failed');

                if (type === 'login') {
                    localStorage.setItem('studentResourceUser', JSON.stringify(data));
                    state.user = data;
                    state.view = 'main';
                    showToast(`Welcome back, ${data.name}!`);
                    fetchRecentBooks();
                    fetchUserBooks(data.email);
                } else {
                    showToast("Account created! Please login.");
                    state.authView = 'login';
                }
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                setLoading(false);
                render();
            }
        }

        // --- USER ACTIONS ---
        async function handleUpload(e) {
            e.preventDefault();
            if(!state.user) return;

            const formData = new FormData(e.target);
            formData.append('uploaderIdentifier', state.user.email);

            setLoading(true);
            render();

            try {
                const res = await fetch(`${API_BASE_URL}/books/upload`, { method: 'POST', body: formData });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Upload failed');
                }
                
                showToast("Resource uploaded successfully!");
                state.activeTab = 'profile';
                fetchUserBooks(state.user.email);
                fetchRecentBooks();
                // Clear form fields
                e.target.reset();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                setLoading(false);
                render();
            }
        }
        
        // --- DOWNLOAD ACTION (NEW) ---
        function handleDownloadClick(bookId) {
             // Redirecting the window to the download API endpoint
             // The backend handles the secure URL generation and forced redirect (302)
             window.open(`${API_BASE_URL}/books/download/${bookId}`, '_blank');
             showToast('Download started (Check browser downloads)', 'success');
        }

        // --- EDIT MODAL ---
        function openEditModal(book) {
            document.getElementById('editBookId').value = book.id;
            document.getElementById('editBookName').value = book.bookName;
            document.getElementById('editDescription').value = book.description;
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        function closeEditModal() {
            editModal.classList.remove('flex');
            editModal.classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const bookId = document.getElementById('editBookId').value;
            const bookName = document.getElementById('editBookName').value;
            const description = document.getElementById('editDescription').value;
            
            const btn = document.getElementById('saveEditBtn');
            const originalText = btn.textContent;
            btn.innerHTML = '<div class="loader-white mr-2"></div> Saving...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/books/${bookId}?updaterIdentifier=${state.user.email}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookName, description })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Edit failed');
                }

                closeEditModal();
                showToast("Resource updated!");
                fetchUserBooks(state.user.email);
                fetchRecentBooks(); 

            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // --- DELETE MODAL ---
        function confirmDelete(bookId) {
            document.getElementById('confirmBookId').value = bookId;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }
        
        function closeConfirmModal() {
            confirmModal.classList.remove('flex');
            confirmModal.classList.add('hidden');
        }

        async function executeDelete() {
            const bookId = document.getElementById('confirmBookId').value;
            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.textContent;
            btn.innerHTML = '<div class="loader-white mr-2"></div> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/books/${bookId}?deleterIdentifier=${state.user.email}`, {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Delete failed');
                }

                closeConfirmModal();
                showToast("File Deleted");
                fetchUserBooks(state.user.email);
                fetchRecentBooks();
                if(state.selectedBook?.id === bookId) state.view = 'main'; 

            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                 btn.innerHTML = originalText;
                 btn.disabled = false;
            }
        }
        // --- END DELETE MODAL ---


        function copyLink(link) {
            const el = document.createElement('textarea');
            el.value = link;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Link copied!', 'success');
                } else {
                    throw new Error("Copy failed");
                }
            } catch (err) {
                 showToast('Copy failed! Copy manually.', 'error');
            } finally {
                document.body.removeChild(el);
            }
        }

        function toggleWishlist(bookId) {
            if (state.wishlist.includes(bookId)) {
                state.wishlist = state.wishlist.filter(id => id !== bookId);
                showToast("Removed from wishlist");
            } else {
                state.wishlist.push(bookId);
                showToast("Added to wishlist");
            }
            localStorage.setItem('sr_wishlist', JSON.stringify(state.wishlist));
            render();
        }

        function handleSearch(query) {
            state.searchQuery = query;
            render();
        }

        // --- HELPER FOR COVER ---
        function getBookCoverHtml(book, heightClass = 'h-32') {
            // This function intentionally uses thumbnailUrl for display
            let thumb = book.thumbnailUrl;
            
            const colors = [
                'bg-red-100 text-red-600', 'bg-orange-100 text-orange-600', 'bg-amber-100 text-amber-600',
                'bg-green-100 text-green-600', 'bg-emerald-100 text-emerald-600', 'bg-teal-100 text-teal-600',
                'bg-cyan-100 text-cyan-600', 'bg-blue-100 text-blue-600', 'bg-indigo-100 text-indigo-600',
                'bg-violet-100 text-violet-600', 'bg-purple-100 text-purple-600', 'bg-fuchsia-100 text-fuchsia-600',
                'bg-pink-100 text-pink-600', 'bg-rose-100 text-rose-600'
            ];
            
            let hash = 0;
            const str = book.bookName || 'file';
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const colorClass = colors[Math.abs(hash) % colors.length];
            const initial = str.charAt(0).toUpperCase();

            if (thumb) {
                // book.thumbnailUrl contains the first page image link (JPG)
                return `<img src="${thumb}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center ${colorClass}\\'><span class=\\'text-4xl font-bold opacity-50\\'>${initial}</span></div>'">`;
            } else {
                return `<div class="w-full h-full flex items-center justify-center ${colorClass}">
                    <span class="text-4xl font-bold opacity-50">${initial}</span>
                </div>`;
            }
        }

        // --- DYNAMIC FILE TYPE HELPER ---
        function getFileIcon(book) {
            // Since backend is restricted to documents, we assume 'documents' folder
            const folder = book.folder ? book.folder.split('/').pop() : 'documents';
            return { icon: 'file-text', tag: 'DOC/PDF', color: 'bg-blue-100 text-blue-700 border-blue-200', folder: folder };
        }


        // --- RENDERERS ---
        function render() {
            if (state.view === 'auth') {
                renderAuth();
            } else if (state.view === 'details') {
                // On entering details view, fetch preview data only if not already loaded
                if (!state.selectedBookPreview || state.selectedBookPreview.bookId !== state.selectedBook.id) {
                     fetchPreview(state.selectedBook.id);
                }
                renderDetails();
            } else {
                state.selectedBookPreview = null; // Clear preview data when leaving details view
                renderMainLayout();
            }
            lucide.createIcons();
        }

        function renderAuth() {
            const isLogin = state.authView === 'login';
            app.innerHTML = `
                <div class="min-h-screen bg-white flex flex-col justify-center px-6 fade-in relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 via-blue-500 to-amber-400"></div>
                    <div class="text-center mb-10">
                        <div class="w-24 h-24 bg-white rounded-3xl mx-auto flex items-center justify-center shadow-2xl border-4 border-blue-50 mb-6 relative">
                            <div class="absolute inset-0 rounded-3xl border border-amber-200"></div>
                            <i data-lucide="graduation-cap" class="text-blue-600 w-12 h-12"></i>
                        </div>
                        <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Student<span class="text-blue-600">Hub</span></h1>
                        <p class="text-slate-500 mt-2 font-medium">Premium Learning Resources</p>
                    </div>

                    <form onsubmit="handleAuth(event, '${isLogin ? 'login' : 'register'}')" class="space-y-5">
                        ${!isLogin ? `
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Full Name</label>
                                <input name="name" type="text" required class="w-full bg-slate-50 border border-slate-200 px-5 py-4 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition font-medium" placeholder="Your Name">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Mobile</label>
                                <input name="mobile" type="tel" required class="w-full bg-slate-50 border border-slate-200 px-5 py-4 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition font-medium" placeholder="Mobile Number">
                            </div>
                        ` : ''}
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Email ID</label>
                            <input name="email" type="email" required placeholder="example@gmail.com" class="w-full bg-slate-50 border border-slate-200 px-5 py-4 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Password</label>
                            <input name="password" type="password" required class="w-full bg-slate-50 border border-slate-200 px-5 py-4 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition font-medium">
                        </div>
                        
                        <button type="submit" ${state.loading ? 'disabled' : ''} class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-xl shadow-blue-200 hover:shadow-2xl hover:-translate-y-0.5 active:scale-95 transition-all flex justify-center items-center text-lg mt-4">
                            ${state.loading ? '<div class="loader-white"></div>' : (isLogin ? 'Login Now' : 'Create Account')}
                        </button>
                    </form>

                    <p class="text-center mt-8 text-slate-500 font-medium">
                        ${isLogin ? "New Student?" : "Already Registered?"} 
                        <button onclick="state.authView='${isLogin ? 'register' : 'login'}'; render()" class="text-blue-600 font-bold hover:underline ml-1">
                            ${isLogin ? 'Register Here' : 'Login Here'}
                        </button>
                    </p>
                </div>
            `;
        }

        function renderMainLayout() {
            let contentHtml = '';
            const isHome = state.activeTab === 'home';

            if (state.activeTab === 'home') contentHtml = renderHomeContent();
            else if (state.activeTab === 'wishlist') contentHtml = renderWishlistContent();
            else if (state.activeTab === 'upload') contentHtml = renderUploadContent();
            else if (state.activeTab === 'profile') contentHtml = renderProfileContent();

            app.innerHTML = `
                <div class="flex-1 flex flex-col bg-[#F0F9FF] overflow-hidden">
                    <!-- HEADER -->
                    ${isHome ? `
                    <div class="bg-white sticky top-0 z-20 px-5 pt-5 pb-3 shadow-sm border-b border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-0.5">STUDENT RESOURCE</h2>
                                <div class="flex items-center text-slate-800 font-bold text-lg leading-none">
                                    <span class="mr-1">Library</span>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded border border-blue-200">PRO</span>
                                </div>
                            </div>
                            <div onclick="state.activeTab='profile'; render()" class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg shadow-blue-200 cursor-pointer border-2 border-white">
                                ${state.user ? state.user.name.charAt(0).toUpperCase() : '<i data-lucide="user" class="w-5 h-5"></i>'}
                            </div>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="relative group">
                            <i onclick="render()" data-lucide="search" class="absolute left-4 top-3.5 text-gray-400 w-5 h-5 cursor-pointer hover:text-blue-500 transition-colors"></i>
                            <input 
                                type="text" 
                                value="${state.searchQuery}"
                                oninput="state.searchQuery = this.value"
                                onkeydown="if(event.key === 'Enter') render()"
                                placeholder="Search 'Physics' or 'Java'..." 
                                class="w-full bg-slate-50 border border-slate-200 text-slate-700 font-medium rounded-2xl pl-12 pr-4 py-3.5 outline-none focus:border-blue-500 focus:bg-white focus:ring-4 focus:ring-blue-50/50 transition-all shadow-inner"
                            >
                        </div>
                    </div>` : ''}

                    <!-- SCROLLABLE AREA -->
                    <div class="flex-1 overflow-y-auto pb-32 no-scrollbar relative">
                        ${contentHtml}
                    </div>

                    <!-- BOTTOM NAV -->
                    <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around py-3 pb-safe z-30 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] rounded-t-3xl">
                        ${renderNavItem('home', 'home', 'Home')}
                        ${renderNavItem('wishlist', 'heart', 'Wishlist')}
                        <!-- FIX: Upload Button is w-16 h-16 (standard size) but centered -->
                        <div class="relative -top-6">
                            <button onclick="state.activeTab='upload'; render()" class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full shadow-xl shadow-green-200 flex items-center justify-center border-4 border-[#F0F9FF] transform transition active:scale-95">
                                <i data-lucide="plus" class="text-white w-8 h-8"></i>
                            </button>
                        </div>
                        ${renderNavItem('profile', 'user', 'Profile')}
                    </div>
                </div>
            `;
        }

        function renderNavItem(id, icon, label) { /* (No changes) */
            const isActive = state.activeTab === id;
            return `
                <button onclick="state.activeTab='${id}'; render()" class="flex flex-col items-center w-16 transition-all duration-300 ${isActive ? '-translate-y-1' : ''}">
                    <div class="${isActive ? 'text-blue-600' : 'text-slate-400'}">
                        <i data-lucide="${icon}" class="${isActive ? 'fill-blue-100' : ''} w-6 h-6 transition-all"></i>
                    </div>
                    <span class="text-[10px] font-bold mt-1 ${isActive ? 'text-blue-600' : 'text-slate-400'} transition-colors">${label}</span>
                </button>
            `;
        }

        function renderHomeContent() { /* (No changes) */
            let displayBooks = state.recentBooks.filter(book => 
                (state.selectedCategory === 'All' || book.bookName.toLowerCase().includes(state.selectedCategory.toLowerCase()) || book.description.toLowerCase().includes(state.selectedCategory.toLowerCase())) &&
                (book.bookName.toLowerCase().includes(state.searchQuery.toLowerCase()) || (book.uploadedByUserName && book.uploadedByUserName.toLowerCase().includes(state.searchQuery.toLowerCase())))
            );

            return `
                <!-- Categories -->
                <div class="pl-5 mt-6">
                    <div class="flex space-x-4 overflow-x-auto hide-scroll pb-4 pr-5">
                        ${categories.map(cat => `
                            <button onclick="state.selectedCategory='${cat.name}'; render()" class="flex flex-col items-center flex-shrink-0 space-y-2 group">
                                <div class="w-16 h-16 ${cat.color} border rounded-2xl flex items-center justify-center shadow-sm ${state.selectedCategory === cat.name ? 'ring-4 ring-offset-2 ring-blue-100 scale-110' : 'group-hover:scale-105'} transition-all duration-300">
                                    <i data-lucide="${cat.icon}" class="w-7 h-7"></i>
                                </div>
                                <span class="text-[11px] font-bold text-slate-600 ${state.selectedCategory === cat.name ? 'text-blue-600' : ''}">${cat.name}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Banner -->
                <div class="px-5 mt-2 fade-in">
                    <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl shadow-slate-200 relative overflow-hidden group">
                        <div class="relative z-10 w-3/4">
                            <span class="bg-amber-400 text-amber-900 text-[10px] font-extrabold px-2 py-1 rounded mb-2 inline-block">PREMIUM</span>
                            <h2 class="text-2xl font-bold mb-1 leading-tight">Exam Prep Made Easy</h2>
                            <p class="text-slate-300 text-xs mb-4">Access curated notes for free.</p>
                            <button onclick="state.activeTab='upload'; render()" class="bg-white text-slate-900 text-xs font-bold px-5 py-2.5 rounded-xl shadow hover:bg-amber-50 transition">Share Notes</button>
                        </div>
                        <div class="absolute -right-4 -bottom-4 w-32 h-32 bg-amber-400/20 rounded-full blur-2xl group-hover:bg-amber-400/30 transition-all duration-500"></div>
                        <i data-lucide="sparkles" class="absolute right-4 bottom-4 text-amber-400 w-16 h-16 opacity-80"></i>
                    </div>
                </div>

                <!-- Grid -->
                <div class="px-5 mt-8 pb-4">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-slate-800 text-lg">Fresh Resources</h3>
                        <span class="text-[10px] font-bold text-slate-400 bg-white px-2 py-1 rounded-lg border border-slate-100">${displayBooks.length} FILES</span>
                    </div>
                    
                    ${state.loading ? 
                        '<div class="flex justify-center py-10"><div class="loader-white border-blue-600 border-t-transparent"></div></div>' : 
                        (displayBooks.length === 0 ? 
                            '<div class="text-center text-slate-400 py-10 bg-white rounded-2xl border border-dashed border-slate-200">No resources found.</div>' : 
                            `<div class="grid grid-cols-2 gap-4">
                                ${displayBooks.map(book => getBookCard(book)).join('')}
                            </div>`
                        )
                    }
                </div>
            `;
        }

        function getBookCard(book) {
            const isWishlisted = state.wishlist.includes(book.id);
            const fileInfo = getFileIcon(book);
            return `
                <div onclick="state.selectedBook=${JSON.stringify(book).replace(/"/g, '&quot;')}; state.view='details'; render()" class="bg-white rounded-2xl p-2.5 shadow-sm border border-slate-100 relative group active:scale-95 transition-all duration-300 hover:shadow-md hover:border-amber-200">
                    <div class="bg-slate-50 rounded-xl h-32 w-full flex items-center justify-center mb-3 overflow-hidden relative border border-slate-100 group-hover:border-amber-100 transition-colors">
                        ${getBookCoverHtml(book)}
                        <div class="absolute top-2 left-2 ${fileInfo.color} text-[9px] font-bold px-2 py-1 rounded-md shadow-sm border ${fileInfo.color.replace('bg-', 'border-').replace('text-', '')} flex items-center gap-1">
                             <i data-lucide="${fileInfo.icon}" class="w-3 h-3"></i> ${fileInfo.tag}
                        </div>
                        
                        <button onclick="event.stopPropagation(); toggleWishlist(${book.id})" class="absolute top-2 right-2 w-7 h-7 bg-white/90 backdrop-blur rounded-full flex items-center justify-center shadow-sm border border-slate-100 active:scale-90 transition">
                            <i data-lucide="heart" class="w-3.5 h-3.5 ${isWishlisted ? 'fill-red-500 text-red-500' : 'text-slate-400'}"></i>
                        </button>
                    </div>

                    <div class="px-1">
                        <h4 class="font-bold text-slate-800 text-sm leading-tight line-clamp-2 h-9 mb-1">${book.bookName}</h4>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded-md">
                                <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                                <span class="truncate max-w-[60px]">${book.uploadedByUserName ? book.uploadedByUserName.split('@')[0] : 'User'}</span>
                            </div>
                            <div class="w-7 h-7 rounded-full bg-blue-50 flex items-center justify-center border border-blue-100 text-blue-600">
                                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUploadContent() {
            return `
                <div class="px-5 py-6 fade-in h-full bg-[#F0F9FF] relative flex flex-col">
                    <!-- Header with Back Button -->
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="state.activeTab='home'; render()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm hover:scale-110 transition text-slate-700">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <h2 class="text-xl font-extrabold text-slate-800">Upload <span class="text-green-600">Resource</span></h2>
                        <div class="w-10"></div> <!-- Spacer for centering -->
                    </div>
                    
                    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-5 mb-8 flex gap-4 shadow-sm">
                        <div class="bg-amber-100 p-3 rounded-full h-fit text-amber-600 shrink-0">
                            <i data-lucide="shield-alert" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-amber-800 mb-1">Upload Guidelines</h4>
                            <p class="text-xs text-amber-700 leading-relaxed font-medium">1. Only PDF and MS Word files are accepted.</p>
                            <p class="text-xs text-amber-700 leading-relaxed font-medium">2. No illegal content or personal data.</p>
                        </div>
                    </div>

                    <form id="uploadForm" onsubmit="handleUpload(event)" class="space-y-6 pb-32">
                        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">File Name</label>
                                <input name="bookName" type="text" required placeholder="e.g. Physics Chapter 1" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-5 py-4 outline-none focus:border-green-500 focus:bg-white focus:ring-4 focus:ring-green-50 transition font-bold text-slate-700 placeholder-slate-400">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Description</label>
                                <textarea name="description" required rows="3" placeholder="Add details..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-5 py-4 outline-none focus:border-green-500 focus:bg-white focus:ring-4 focus:ring-green-50 transition font-medium text-slate-700 resize-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Attachment (PDF or DOCX)</label>
                                <label class="flex flex-col items-center justify-center w-full h-36 border-2 border-slate-200 border-dashed rounded-2xl cursor-pointer bg-slate-50 hover:bg-slate-100 hover:border-green-400 transition group">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm mb-3 group-hover:scale-110 transition">
                                            <i data-lucide="cloud-upload" class="w-6 h-6 text-green-500"></i>
                                        </div>
                                        <p class="text-xs text-slate-500 font-bold group-hover:text-green-600 transition"><span class="text-blue-600">Click to upload</span> or drag and drop</p>
                                    </div>
                                    <input name="file" type="file" required class="hidden" accept=".pdf,.doc,.docx" />
                                </label>
                            </div>
                        </div>

                        <!-- Sticky Submit Button (FIXED POSITION) -->
                        <div class="fixed bottom-0 left-0 w-full px-5 pb-safe z-40 bg-white pt-3 shadow-[0_-5px_15px_rgba(0,0,0,0.08)] rounded-t-2xl">
                            <button type="submit" ${state.loading ? 'disabled' : ''} class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-2xl shadow-xl shadow-green-200 hover:shadow-2xl hover:-translate-y-1 active:scale-95 transition-all flex justify-center items-center text-lg border-2 border-white/20 mb-3">
                                ${state.loading ? '<div class="loader-white"></div>' : 'Publish Resource'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderWishlistContent() {
            const wishlistBooks = state.recentBooks.filter(b => state.wishlist.includes(b.id));
            return `
                <div class="px-5 py-6 fade-in min-h-screen bg-[#F0F9FF]">
                    <h2 class="text-2xl font-extrabold text-slate-800 mb-6">Saved <span class="text-red-500">Items</span></h2>
                    ${wishlistBooks.length === 0 ? `
                        <div class="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
                            <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="heart-off" class="w-8 h-8 text-slate-300"></i>
                            </div>
                            <p class="text-slate-400 text-sm font-medium">Your wishlist is empty</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-2 gap-4">
                            ${wishlistBooks.map(book => getBookCard(book)).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderProfileContent() {
            if(!state.user) return `<div class="p-10 text-center"><div class="loader-white border-blue-600 border-t-transparent"></div></div>`;
            
            const myUploadsHtml = state.userBooks.length === 0 ? 
                `<div class="text-center py-6 text-slate-400 border border-dashed border-slate-200 rounded-xl bg-white">No files uploaded yet.</div>` :
                state.userBooks.map(book => `
                    <div onclick="state.selectedBook=${JSON.stringify(book).replace(/"/g, '&quot;')}; state.view='details'; render()" class="flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-3 active:scale-[0.98] transition">
                        <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            ${getBookCoverHtml(book, 'w-10 h-10').replace('w-full h-full', 'w-full h-full rounded-lg')}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-slate-800 truncate">${book.bookName}</h4>
                            <p class="text-[10px] text-slate-400">Uploaded: ${new Date(book.uploadDate).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button onclick="event.stopPropagation(); openEditModal(${JSON.stringify(book).replace(/"/g, '&quot;')})" class="w-8 h-8 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center hover:bg-blue-100 transition" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="event.stopPropagation(); confirmDelete(${book.id})" class="w-8 h-8 bg-red-50 text-red-600 rounded-full flex items-center justify-center hover:bg-red-100 transition" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="bg-white min-h-screen">
                    <div class="bg-gradient-to-b from-slate-900 to-slate-800 px-5 pt-12 pb-32 rounded-b-[3rem] shadow-xl text-center relative">
                        <div class="w-24 h-24 bg-white p-1 rounded-full mx-auto mb-4 shadow-2xl relative z-10">
                            <div class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-4xl font-bold text-slate-700 border-4 border-slate-50">
                                ${state.user.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="absolute bottom-0 right-0 w-8 h-8 bg-green-500 border-4 border-white rounded-full"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-white">${state.user.name}</h2>
                        <p class="text-slate-400 text-sm font-medium">${state.user.email}</p>
                    </div>

                    <div class="px-5 -mt-20 relative z-10 pb-6">
                        <!-- Stats -->
                        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-6 flex justify-between items-center mb-6 border border-slate-50">
                            <div class="text-center flex-1 border-r border-slate-100">
                                <p class="text-2xl font-bold text-blue-600">${state.userBooks.length}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mt-1">Uploads</p>
                            </div>
                            <div class="text-center flex-1">
                                <p class="text-2xl font-bold text-pink-500">${state.wishlist.length}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mt-1">Saved</p>
                            </div>
                        </div>
                        
                        <!-- My Uploads Section -->
                        <h3 class="font-bold text-slate-800 text-lg mb-4">My Uploaded Resources</h3>
                        <div class="space-y-3">
                            ${myUploadsHtml}
                        </div>

                        <!-- Menu -->
                        <div class="mt-8 space-y-3">
                            <h3 class="font-bold text-slate-800 text-lg mb-2">Support</h3>
                            <a href="${INSTAGRAM_LINK}" target="_blank" class="flex items-center bg-slate-50 p-4 rounded-2xl border border-slate-100 active:scale-95 transition hover:bg-white hover:shadow-md hover:border-pink-100 group">
                                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center mr-4 shadow-sm text-pink-500 group-hover:scale-110 transition">
                                    <i data-lucide="instagram" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-sm text-slate-800">Contact / Support</h4>
                                    <p class="text-[10px] text-slate-400 font-bold">Follow on Instagram</p>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                            </a>

                            <button onclick="localStorage.removeItem('studentResourceUser'); state.user=null; state.view='auth'; state.authView='login'; render()" class="w-full flex items-center bg-red-50 p-4 rounded-2xl border border-red-100 active:scale-95 transition mt-6 group">
                                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center mr-4 shadow-sm text-red-500 group-hover:scale-110 transition">
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1 text-left">
                                    <h4 class="font-bold text-sm text-red-600">Log Out</h4>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetails() {
            const book = state.selectedBook;
            const previewData = state.selectedBookPreview;
            const fileInfo = getFileIcon(book);
            
            // Check loading state or error state for preview
            let previewContent = '';
            
            if (state.loading) {
                previewContent = `<div class="text-center py-10"><div class="loader-white border-blue-600 border-t-transparent mx-auto"></div><p class="text-sm mt-3 text-slate-500">Fetching preview pages...</p></div>`;
            } else if (previewData && previewData.error) {
                 previewContent = `<div class="text-center py-8 bg-red-50/50 rounded-xl border border-red-200 text-red-700 font-medium">Error loading preview: ${previewData.message}</div>`;
            } else if (previewData && previewData.previewPages && previewData.previewPages.length > 0) {
                previewContent = `
                    <div class="mt-6 border-t pt-4 border-slate-100">
                        <h3 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2">
                           <i data-lucide="image" class="w-4 h-4 text-green-600"></i> Document Preview (${previewData.previewPages.length} Pages)
                        </h3>
                        <div class="space-y-4">
                            ${previewData.previewPages.map((pageUrl, index) => `
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                    <p class="text-[10px] font-bold text-slate-500 uppercase px-3 py-1 bg-slate-50 border-b border-slate-100">Page ${index + 1}</p>
                                    <img src="${pageUrl}" alt="Preview Page ${index + 1}" class="w-full object-cover">
                                </div>
                            `).join('')}
                        </div>
                        <a href="${previewData.fullViewUrl}" target="_blank" class="block text-center mt-4 text-xs font-bold text-blue-600 hover:underline">Open Full Document in Browser</a>
                    </div>
                `;
            } else if (previewData) {
                previewContent = `<div class="text-center py-8 bg-slate-50 rounded-xl border border-slate-200 text-slate-500 font-medium">No preview pages available (Might be DOCX or internal error).</div>`;
            }

            // Determine action label based on file type
            let actionLabel = `Download ${fileInfo.tag}`;
            let actionIcon = 'download';
            
            // For documents, we show an eye icon for viewing/download
            if (fileInfo.folder === 'documents') {
                actionLabel = `View/Download ${fileInfo.tag}`;
                actionIcon = 'eye';
            }


            app.innerHTML = `
                <div class="min-h-screen bg-white flex flex-col fade-in relative">
                    <!-- Top Image BG -->
                    <div class="h-64 w-full bg-slate-50 relative flex items-center justify-center overflow-hidden">
                        ${getBookCoverHtml(book)}
                        <div class="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                        
                        <!-- Header Actions -->
                        <div class="absolute top-0 left-0 w-full p-5 flex justify-between items-center z-10">
                            <button onclick="state.view='main'; render()" class="w-10 h-10 bg-white/80 backdrop-blur rounded-full flex items-center justify-center shadow-sm hover:scale-110 transition">
                                <i data-lucide="arrow-left" class="w-5 h-5 text-slate-700"></i>
                            </button>
                            <button onclick="toggleWishlist(${book.id})" class="w-10 h-10 bg-white/80 backdrop-blur rounded-full flex items-center justify-center shadow-sm hover:scale-110 transition">
                                <i data-lucide="heart" class="w-5 h-5 ${state.wishlist.includes(book.id) ? 'fill-red-500 text-red-500' : 'text-slate-400'}"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 px-6 -mt-10 relative z-10 pb-24">
                        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-6 border border-slate-50">
                            <!-- Dynamic Tag -->
                            <div class="${fileInfo.color} text-[10px] font-extrabold px-3 py-1 rounded-full uppercase tracking-wider mb-3 inline-block border ${fileInfo.color.replace('bg-', 'border-').replace('text-', '')}">
                                ${fileInfo.tag}
                            </div>
                            <h1 class="text-2xl font-bold text-slate-900 leading-tight mb-4">${book.bookName}</h1>
                            
                            <div class="flex items-center justify-between border-t border-b border-slate-100 py-4 mb-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center mr-3 text-slate-500">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase">Uploader</p>
                                        <p class="text-xs font-bold text-slate-700 max-w-[100px] truncate">${book.uploadedByUserName || 'Unknown'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center mr-3 text-slate-500">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase">Date</p>
                                        <p class="text-xs font-bold text-slate-700">${new Date(book.uploadDate).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>

                            <h3 class="text-sm font-bold text-slate-900 mb-2">Description</h3>
                            <p class="text-sm text-slate-500 leading-relaxed font-medium">${book.description}</p>
                        </div>

                        <!-- DYNAMIC PREVIEW CONTENT (Page 1-5 Images) -->
                        ${previewContent}

                        <!-- DEBUGGING INFO (Optional) -->
                        <div class="mt-4 p-4 bg-slate-100/50 rounded-xl text-xs text-slate-600 border border-slate-200">
                            <p class="font-bold mb-1 text-red-600">DEBUG INFO (For troubleshooting only):</p>
                            <p class="truncate">Download API Link: <span class="text-xs text-blue-800 break-all">${API_BASE_URL}/books/download/${book.id}</span></p>
                            <p class="truncate">Preview API Link: <span class="text-xs text-blue-800 break-all">${API_BASE_URL}/books/view/${book.id}</span></p>
                        </div>
                    </div>

                    <!-- Footer Action (Download Button) -->
                    <div class="fixed bottom-0 w-full bg-white p-5 border-t border-slate-100 pb-safe shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] rounded-t-3xl z-20">
                        <div class="flex space-x-3">
                            <button onclick="copyLink('${API_BASE_URL}/books/download/${book.id}')" class="w-16 bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl flex items-center justify-center active:scale-95 transition-all hover:bg-slate-200 border border-slate-200" title="Copy Download Link">
                                <i data-lucide="link" class="w-5 h-5"></i>
                            </button>
                            <!-- FIX: Button calls local JS function which hits the Download API and redirects -->
                            <button onclick="handleDownloadClick(${book.id})" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 flex items-center justify-center active:scale-95 transition-all hover:shadow-xl hover:-translate-y-1 text-lg">
                                <i data-lucide="${actionIcon}" class="w-5 h-5 mr-3"></i>
                                ${actionLabel}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `${type === 'error' ? 'bg-red-500' : 'bg-slate-800'} text-white px-5 py-3 rounded-2xl shadow-xl text-xs font-bold flex items-center gap-3 animate-bounce border-2 border-white/10`;
            toast.innerHTML = `<i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}" class="w-4 h-4"></i><span>${msg}</span>`;
            toastContainer.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        }

        function setLoading(bool) {
            state.loading = bool;
        }

        // --- HELPER FOR COVER ---
        function getBookCoverHtml(book, heightClass = 'h-32') {
            // This function intentionally uses thumbnailUrl for display
            let thumb = book.thumbnailUrl;
            
            const colors = [
                'bg-red-100 text-red-600', 'bg-orange-100 text-orange-600', 'bg-amber-100 text-amber-600',
                'bg-green-100 text-green-600', 'bg-emerald-100 text-emerald-600', 'bg-teal-100 text-teal-600',
                'bg-cyan-100 text-cyan-600', 'bg-blue-100 text-blue-600', 'bg-indigo-100 text-indigo-600',
                'bg-violet-100 text-violet-600', 'bg-purple-100 text-purple-600', 'bg-fuchsia-100 text-fuchsia-600',
                'bg-pink-100 text-pink-600', 'bg-rose-100 text-rose-600'
            ];
            
            let hash = 0;
            const str = book.bookName || 'file';
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const colorClass = colors[Math.abs(hash) % colors.length];
            const initial = str.charAt(0).toUpperCase();

            if (thumb) {
                // book.thumbnailUrl contains the first page image link (JPG)
                return `<img src="${thumb}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center ${colorClass}\\'><span class=\\'text-4xl font-bold opacity-50\\'>${initial}</span></div>'">`;
            } else {
                return `<div class="w-full h-full flex items-center justify-center ${colorClass}">
                    <span class="text-4xl font-bold opacity-50">${initial}</span>
                </div>`;
            }
        }

        // --- DYNAMIC FILE TYPE HELPER ---
        function getFileIcon(book) {
            // Since backend is restricted to documents, we assume 'documents' folder
            const folder = book.folder ? book.folder.split('/').pop() : 'documents';
            return { icon: 'file-text', tag: 'DOC/PDF', color: 'bg-blue-100 text-blue-700 border-blue-200', folder: folder };
        }

        init();
    </script>
</body>
</html>
